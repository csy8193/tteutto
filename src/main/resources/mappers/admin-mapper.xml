<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="adminMapper">


	<!-- Admin VO -->
	<resultMap type="Admin" id="admin_rm">
		<id property="classNo" column="CLASS_NO" />
		
		<result property="className" column="CLASS_NM" />
		<result property="classRequestDate" column="CLASS_REQ_DT" />
		
		<result property="episodeCount" column="EP_COUNT" />
		
		<result property="memberName" column="MEMBER_NM" />
		<result property="memberNo" column="MEMBER_NO" />
	</resultMap>
	
	
	
	<!-- 강사 VO -->
	<resultMap type="AdminTeacher" id="adminTeacher_rm">
		<id property="memberNo" column="MEMBER_NO" />
		
		<result property="memberName" column="MEMBER_NM" />
		
		<result property="teacherImg" column="TEACHER_IMG" />
		<result property="teacherIntro" column="TEACHER_INTRO" />
		<result property="teacherRequestDate" column="TEACHER_REQ_DT" />
		<result property="teacherStatus" column="TEACHER_ST" />
		
		<collection property="careerList" column="MEMBER_NO" 
					javaType="java.util.ArrayList" ofType="AdminTeacherCareer" select="selectTeacherCareerList" />
					
		<collection property="snsList" column="MEMBER_NO" 
					javaType="java.util.ArrayList" ofType="AdminTeacherSNS" select="selectTeacherSnsList" />
	</resultMap>
	
	<!-- 강사 경력 VO -->
	<resultMap type="AdminTeacherCareer" id="career_rm">
		<id property="careerNo" column="CAREER_NO"/>
		<result property="careerContent" column="CAREER_CONTENT"/>
		<result property="careerImg" column="CAREER_IMG"/>
		<result property="memberNo" column="MEMBER_NO"/>
	</resultMap>
	
	<!-- 강사 sns 링크 VO -->
	<resultMap type="AdminTeacherSNS" id="sns_rm">
		<id property="snsNo" column="SNS_NO"/>
		<result property="snsLink" column="SNS_LINK"/>
		<result property="memberNo" column="MEMBER_NO"/>
	</resultMap>
	
	<!-- 신고 VO -->
	<resultMap type="AdminReport" id="report_rm">
		<id property="reportNo" column="REPORT_NO"/>
		<result property="reportDiv" column="REPORT_DIV"/>
		<result property="reportContent" column="REPORT_CONTENT"/>
		<result property="reportStatus" column="REPORT_ST"/>
		<result property="reportRequestDate" column="REPORT_REQ_DT"/>
		<result property="registerNo" column="REG_NO"/>
		<result property="reportName" column="REPORT_NM"/>
		<result property="reportTarget" column="REPORT_TARGET"/>
		<result property="reportTargetNo" column="REPORT_TARGET_NO"/>
		<result property="reportCount" column="REPORT_COUNT"/>
	</resultMap>
	
	
	<!-- ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// -->
	<!-- ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// -->
	<!-- ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// -->
	
	
	<!-- 강사 커리어 조회 -->
	<select id="selectTeacherCareerList" resultMap="career_rm">
		SELECT * FROM CAREER
		WHERE MEMBER_NO = #{memberNo}
	</select>
	
	<!-- 강사 커리어 조회 -->
	<select id="selectTeacherSnsList" resultMap="sns_rm">
		SELECT * FROM SNS
		WHERE MEMBER_NO = #{memberNo}
	</select>
	
	
	<!-- 회차별 목록 조회 -->
	<select id="classEpisodeList" resultMap="admin_rm">
		SELECT CLASS_NO, CLASS_NM, CLASS_REQ_DT, EP_COUNT, MEMBER_NM, MEMBER_NO FROM CLASS
		JOIN EPISODE USING(CLASS_NO)
		JOIN TEACHER USING(MEMBER_NO)
		JOIN MEMBER USING(MEMBER_NO)
		WHERE EP_ST = 0
	</select>
	
	
	<!-- 회차별 신청 승인 -->
	<update id="episodeAgree">
		UPDATE EPISODE SET EP_ST = 2
		WHERE CLASS_NO = #{classNo}
	</update>
	
	<!-- 쪽지 보내기 -->
	<insert id="sendNote">
		INSERT INTO NOTE VALUES(SEQ_NOTE_NO.NEXTVAL, #{noteContent}, DEFAULT, #{memberNo})
	</insert>
	
	<!-- 회차별 신청 거절 -->
	<update id="episodeDeny">
		UPDATE EPISODE SET EP_ST = 3
		WHERE CLASS_NO = #{classNo}
	</update>
	
	<select id="classList" resultMap="admin_rm">
		SELECT CLASS_NO, CLASS_NM, CLASS_REQ_DT, MEMBER_NM, MEMBER_NO FROM CLASS
		JOIN TEACHER USING(MEMBER_NO)
		JOIN MEMBER USING(MEMBER_NO)
		WHERE CLASS_ST = 0
	</select>
	
	<!-- 클래스 신청 승인 -->
	<update id="classAgree">
		UPDATE CLASS SET CLASS_ST = 2
		WHERE CLASS_NO = #{classNo}
	</update>
	
	<!-- 클래스 신청 거절 -->
	<update id="classDeny">
		UPDATE CLASS SET CLASS_ST = 3
		WHERE CLASS_NO = #{classNo}
	</update>
	
	<!-- 강사 목록 조회 -->
	<select id="teacherList" resultMap="adminTeacher_rm">
		SELECT MEMBER_NO, TEACHER_REQ_DT, MEMBER_NM FROM TEACHER
		JOIN MEMBER USING(MEMBER_NO)
		WHERE TEACHER_ST = 0
	</select>
	
	<!-- 강사 신청 승인 -->
	<update id="teacherAgree">
		UPDATE TEACHER SET TEACHER_ST = 2
		WHERE MEMBER_NO = #{memberNo}
	</update>
	
	<!-- 강사 신청 거절 -->
	<update id="teacherDeny">
		UPDATE TEACHER SET TEACHER_ST = 3
		WHERE MEMBER_NO = #{memberNo}
	</update>
	
	<!-- 강사 정보 조회 -->
	<select id="selectTeacher" resultMap="adminTeacher_rm">
		SELECT TEACHER_IMG, TEACHER_INTRO, MEMBER_NM, MEMBER_NO FROM TEACHER
		JOIN MEMBER USING(MEMBER_NO)
		WHERE MEMBER_NO = #{memberNo}
	</select>
	
	<select id="studentReportList" resultMap="report_rm">
		SELECT A.*, 

		(SELECT COUNT(*) FROM REPORT R
		WHERE R.REG_NO = A.REG_NO AND REPORT_ST = 2) "REPORT_COUNT"
		
		FROM
		
		(SELECT REG_NM "REPORT_TARGET", REPORT_CONTENT, MEMBER_NM "REPORT_NM", REG_NO, REPORT_REQ_DT, REPORT_NO, REGISTER.MEMBER_NO "REPORT_TARGET_NO"
		FROM REPORT
		JOIN REGISTER USING(REG_NO)
		JOIN EPISODE USING(EP_NO)
		JOIN CLASS C USING(CLASS_NO)
		JOIN TEACHER T ON(T.MEMBER_NO = C.MEMBER_NO)
		JOIN MEMBER M ON(M.MEMBER_NO = T.MEMBER_NO)
		WHERE REPORT_DIV = 1 AND REPORT_ST = 0) A
	</select>
	
	<!-- 학생 신고 신청 승인/거절 -->
	<update id="reportAgreeDeny">
		UPDATE REPORT SET REPORT_ST = #{reportStatus} WHERE REPORT_NO = #{reportNo}
	</update>
	
	<!-- 계정 정지 -->
	<update id="memberBan">
		UPDATE MEMBER SET MEMBER_ST = 2 WHERE MEMBER_NO = #{reportTargetNo}
	</update>
	
</mapper>
